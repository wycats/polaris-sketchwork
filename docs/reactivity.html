<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Polaris Reactivity - Polaris Design Sketches</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="proposals.html"><strong aria-hidden="true">1.</strong> Polaris Sketchwork</a></li><li class="chapter-item expanded "><a href="reactivity.html" class="active"><strong aria-hidden="true">2.</strong> Polaris Reactivity</a></li><li class="chapter-item expanded "><a href="match.html"><strong aria-hidden="true">3.</strong> #match Control Flow</a></li><li class="chapter-item expanded "><a href="routing.html"><strong aria-hidden="true">4.</strong> Routing</a></li><li class="chapter-item expanded "><a href="content-tag.html"><strong aria-hidden="true">5.</strong> Content Tag</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="content-tag/simplified-javascript-lexer.html"><strong aria-hidden="true">5.1.</strong> Appendix: Simplified JavaScript Lexer</a></li><li class="chapter-item expanded "><a href="content-tag/second-phase-compiler.html"><strong aria-hidden="true">5.2.</strong> Appendix: Optional Second Phase</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Polaris Design Sketches</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ember-reactivity"><a class="header" href="#ember-reactivity">Ember Reactivity</a></h1>
<blockquote>
<p>Note to readers: For the most part, this design document describes the current state of the Ember.js reactivity system, as of Octane, as a way of laying the groundwork for understanding Polaris features. When this document is talking about Polaris features, it explicitly calls that out.</p>
</blockquote>
<h2 id="how-ember-reactivity-works"><a class="header" href="#how-ember-reactivity-works">How Ember Reactivity Works</a></h2>
<h3 id="the-data-universe"><a class="header" href="#the-data-universe">The Data Universe</a></h3>
<dl>
  <dt id="data-reactive-storage">Reactive Data Cell</dt>
  <dd>
<p>An atomic piece of reactive storage that the app can read from or write to.</p>
<p>In Octane, the only kind of Reactive Cell is a <code>@tracked</code> field. Polaris will also include a <code>cell</code> type to create standalone reactive storage outside of a class.</p>
</dd>
<dt id="data-composite">Composite Reactive Object</dt>
  <dd>
<p>An object that uses multiple reactive values internally. A Composite Reactive Object exposes methods to read and write to its underlying reactive values.</p>
<p>Composite Reactive Objects are <em>Constructed</em> when they are first first created. The code that constructs a Reactive Object is called a <em>Reactive Constructor</em>.</p>
<p>The code in a Reactive Constructor may <em>read</em> from the data universe, but it must not <em>write to</em> the data universe. <strong>However</strong>, if a <em>Reactive Constructor</em> initializes a reactive variable for the first time, it <strong>may</strong> mutate the reactive variable for the duration of the Reactive Constructor.</p>
</dd>
<dt id="data-universe">The Data Universe</dd>
  <dd>The collection of all Reactive Storage.</dd>
<dt id="data-formula">Formula</dt>
  <dd>
<p>Normal JavaScript functions or getters that compute values based on other reactive values. These functions do not need to be annotated, but they must not mutate the data universe.</p>
<p>The Ember <a href="#output-rendering">Rendering</a> process <strong>reads</strong> from Reactive Storage and Formulas in the data universe, but <strong>must not write to it</strong>. (In Ember, Formulas used in the Rendering process are called &quot;helpers&quot;.)</p>
<blockquote>
<p>👍 A good rule of thumb: don't mutate anything in your getters or helpers.</p>
</blockquote>
</dd>
</dl>
<p>Polaris will include a number of built-in <a href="#data-composite">Composite Reactive Objects</a>: Map, Set, WeakMap, WeakSet, array and object.</p>
<blockquote>
<p>💡 All reactive storage built into Ember follows the <strong>Equivalence</strong> rule. This means that they are (a) annotations of storage built into JavaScript, (b) have the same behavior as the underlying JavaScript storage, and (c) behave equivalently if the annotation is removed. The annotation causes the <a href="#output-rendering">rendered</a> output to remain up to date when the storage is mutated, but it does not affect the behavior or timing of the data itself.</p>
</blockquote>
<h4 id="the-data-universe-is-always-coherent"><a class="header" href="#the-data-universe-is-always-coherent">The Data Universe is Always Coherent</a></h4>
<p>When <em>Reactive Storage</em> is mutated, the mutation takes effect immediately. Any code that reads from the variable will see the new value.</p>
<p>This means that the <em>Data Universe</em> <strong>is always coherent</strong>. If you make a change to a reactive variable, and you call a function that depends on the reactive variable, the function will see the new state of the reactive variable, and the value it returns will therefore be up to date.</p>
<details id="ember-reactivity-example">
<summary>Example</summary>
<pre><code class="language-ts">class Person {
  @tracked name: string;
  @tracked location: string;

  constructor(name: string, location: string) {
    this.name = name;
    this.location = location;
  }

  get card() {
    return `${this.name} (${this.location})`;
  }
}

const wycats = new Person(&quot;Yehuda&quot;, &quot;New York&quot;);

wycats.card; // &quot;Yehuda (New York)&quot;

wycats.name = &quot;Yehuda Katz&quot;;
wycats.card; // &quot;Yehuda Katz (New York)&quot;

wycats.location = &quot;San Francisco&quot;;
wycats.card; // &quot;Yehuda Katz (San Francisco)&quot;

wycats.location = &quot;Portland&quot;;
wycats.card; // &quot;Yehuda Katz (Portland)&quot;
</code></pre>
</details>
<h3 id="the-output"><a class="header" href="#the-output">The Output</a></h3>
<dl>
  <dt id="output-rendering">Rendering</dt>
  <dd>
<p>Ember <em>reads</em> from Reactive Variables, as well as functions and getters that depend on reactive variables, in order to create and update the DOM.</p>
<p>Functions and getters called during Rendering are called <em>Formulas</em>. Formulas may <strong>read</strong> from the data universe, but they must not <strong>mutate</strong> the Data Universe.</p>
</dd>
<dt>Actions</dt>
  <dd>
<p>An <em>Action</em> is any code that runs inside of a browser callback, such as a click handler. Actions may freely read or mutate the Data Universe. By definition, an <em>Action</em> does not happen during <em>Rendering</em>.</p>
</dd>
</dl>
<p>The constructor in the <code>Person</code> class <a href="#ember-reactivity-example">above</a> is a <em>Reactive Constructor</em>.</p>
<h3 id="resources"><a class="header" href="#resources">Resources</a></h3>
<p>A <em>Resource</em> is a user-defined <a href="#data-composite">Composite Reactive Object</a> with cleanup behavior. You get access to a resource's <em>value</em> by linking it to a parent object. When the parent object is destroyed, the resource is destroyed as well, which means its cleanup behavior is run.</p>
<p>For example, a Resource might be a class that represents the current version of a document delivered over a web socket. When the connection is closed, the web socket should be closed.</p>
<h4 id="example"><a class="header" href="#example">Example</a></h4>
<pre><code class="language-js">import { Resource, cell } from &quot;@glimmer/reactivity&quot;;

function RemoteData(url) {
  return Resource((resource) =&gt; {
    const value = cell({ type: &quot;loading&quot; });
    const controller = new AbortController();

    resource.on.cleanup(() =&gt; controller.abort());

    fetch(url, { signal: controller.signal })
      .then((response) =&gt; {
        if (response.ok) {
          return response.json();
        } else {
          value.current = { type: &quot;error&quot;, value: response.statusText };
        }
      })
      .then((data) =&gt; {
        value.current = { type: &quot;success&quot;, value: data };
      });

    return value;
  });
}
</code></pre>
<details>
<summary>In TypeScript</summary>
<pre><code class="language-ts">import { Resource, type Linkable, cell } from &quot;@glimmer/reactivity&quot;;

function RemoteData&lt;T&gt;(url: string): Linkable&lt;RemoteData&lt;T&gt;&gt; {
  return Resource((resource) =&gt; {
    const value = cell({ type: &quot;loading&quot; });
    const controller = new AbortController();

    resource.on.cleanup(() =&gt; controller.abort());

    fetch(url, { signal: controller.signal })
      .then((response) =&gt; {
        if (response.ok) {
          return response.json();
        } else {
          value.current = { type: &quot;error&quot;, value: response.statusText };
        }
      })
      .then((data) =&gt; {
        value.current = { type: &quot;success&quot;, value: data };
      });
  });
}

type RemoteData&lt;T&gt; =
  | {
      type: &quot;loading&quot;;
    }
  | {
      type: &quot;success&quot;;
      data: T;
    }
  | {
      type: &quot;error&quot;;
      error: Error;
    };
</code></pre>
</details>
<p>In this example, the <code>RemoteData</code> function takes a URL and returns a linkable resource.</p>
<p>The <code>Resource</code> function is similar to <code>new Promise</code> in JavaScript. It takes a callback that constructs the resource (a <a href="#data-composite">reactive constructor</a>).</p>
<p>In this case, the resource's constructor uses a <a href="#data-reactive-storage">cell</a> to represent the current state of the resource. It uses an <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortController">AbortController</a> to make the fetch abortable, and then registers a resource cleanup handler that aborts it.</p>
<p>It initiates the fetch, and in response to the fetch succeeding or failing, it sets the value of the cell.</p>
<p>Finally, it returns the cell, which is the <strong>value</strong> of the resource.</p>
<p>And this is how it's used in a component:</p>
<pre><code class="language-js">import { use, resource } from &quot;@glimmer/reactivity&quot;;

export default class UserComponent extends Component {
  @use user = resource(() =&gt;
    RemoteData(`https://api.example.com/users/${this.args.id}`)
  );

  &lt;template&gt;
    {{#if (eq (user.type) &quot;loading&quot;)}}
      Loading...
    {{else if (eq (user.type) &quot;error&quot;)}}
      Error: {{user.value}}
    {{else}}
      Hi! {{user.value.name}}
    {{/if}}
  &lt;/template&gt;
}
</code></pre>
<details>
<summary>With the #match Proposal</summary>
<pre><code class="language-js">import { use, resource } from &quot;@glimmer/reactivity&quot;;
import { RemoteData } from &quot;#lib/remote-data&quot;;

export default class UserComponent extends Component {
  @use user = resource(() =&gt;
    RemoteData(&quot;https://api.example.com/users/${this.args.id}&quot;)
  );

  &lt;template&gt;
    {{#match this.user}}
      {{:when &quot;loading&quot;}}
        Loading...
      {{:when &quot;error&quot; as |error|}}
        Error: {{error}}
      {{:when &quot;success&quot; as |user|}}
        Hi! {{user}}
    {{/match}}
  &lt;/template&gt;
}
</code></pre>
</details>
<h4 id="details"><a class="header" href="#details">Details</a></h4>
<ol>
<li>If you return a <a href="#data-reactive-storage">cell</a> or formula (a function with no parameters) from a resource constructor, the value of the resource is the value of the cell or return value of the formula. Otherwise, value of the resource is the return value of the resource constructor.</li>
<li>The <code>@use</code> decorator links the resource to the instance of the object that it's used in (in this case, the component).</li>
<li>The function passed to <code>resource()</code> is, itself, a formula. If it uses reactive values when constructing the resource, and they change, the resource will be cleaned up and re-created. (This effectively makes resources <a href="http://ember-concurrency.com/docs/task-concurrency/#restartable">restartable</a> by default).</li>
</ol>
<h4 id="using-resources-in-templates"><a class="header" href="#using-resources-in-templates">Using Resources in Templates</a></h4>
<p>Resources are used in templates the way helpers are used in Octane.</p>
<blockquote>
<p>💡 That's because resources and helpers are <strong>the same thing</strong> in Polaris.</p>
</blockquote>
<pre><code class="language-ts">import { RemoteData } from &quot;#app/lib/remote-data&quot;;

&lt;template&gt;
  {{#let (RemoteData (concat &quot;https://api.example.com/users/&quot; @id)) as |data|}}
    {{#if (eq (data.type) &quot;loading&quot;)}}
      Loading...
    {{else if (eq (data.type) &quot;error&quot;)}}
      Error: {{data.value}}
    {{else}}
      Hi! {{data.value.name}}
    {{/if}}
  {{/let}}
&lt;/template&gt;
</code></pre>
<details>
<summary>With #match Proposal</summary>
<pre><code class="language-ts">import { RemoteData } from &quot;#app/lib/remote-data&quot;;

&lt;template&gt;
  {{#let (RemoteData (concat &quot;https://api.example.com/users/&quot; @id)) as |data|}}
    {{#match data}}
      {{:when &quot;loading&quot;}}
        Loading...
      {{:when &quot;error&quot; as |error|}}
        Error: {{error}}
      {{:when &quot;success&quot; as |user|}}
        Hi! {{user.name}}
    {{/match}}
  {{/let}}
&lt;/template&gt;
</code></pre>
</details>
<p>Two differences between using a resource in a template and using a resource in a class:</p>
<ul>
<li>In a class, you use <code>@use</code> to link the resource's lifetime to the lifetime of the class instance. In a template, that happens automatically.</li>
<li>In a class, you construct the resource with <code>resource(() =&gt; ...)</code>. In a template, you don't need to wrap the call to <code>RemoteData</code>, because the template syntax already does that for you.</li>
</ul>
<h2 id="relationship-to-octane-features"><a class="header" href="#relationship-to-octane-features">Relationship to Octane Features</a></h2>
<ul>
<li>Resources are a generalization of <a href="https://emberjs.com/api/ember/2.18/classes/Helper/methods/helper?anchor=class-helper">Class Helpers</a> that can be used <a href="#using-resources-in-templates">in templates</a>, but also in normal JavaScript.</li>
</ul>
<h2 id="relationship-to-shipped-primitives"><a class="header" href="#relationship-to-shipped-primitives">Relationship to Shipped Primitives</a></h2>
<ul>
<li>The lifetime linking feature of resources is built on <a href="https://api.emberjs.com/ember/4.3/functions/@ember%2Fdestroyable/associateDestroyableChild">associateDestroyableChild</a>.</li>
<li>The ability to register cleanup handlers outside of <code>willDestroy</code> is built on <a href="https://api.emberjs.com/ember/4.3/functions/@ember%2Fdestroyable/registerDestructor">registerDestructor</a>.</li>
<li>Automatically cleaning up the resource when its arguments change is built on <a href="https://api.emberjs.com/ember/4.3/functions/@ember%2Fdestroyable/destroy">destroy</a> and <a href="https://api.emberjs.com/ember/4.3/functions/@glimmer%2Ftracking%2Fprimitives%2Fcache/createCache">createCache</a>.</li>
</ul>
<h2 id="relationship-to-approved-but-unshipped-primitives"><a class="header" href="#relationship-to-approved-but-unshipped-primitives">Relationship to Approved but Unshipped Primitives</a></h2>
<ul>
<li>Cell is built on <a href="https://github.com/emberjs/rfcs/blob/master/text/0669-tracked-storage-primitive.md">createStorage</a> (approved RFC #669). It could mostly be built on top of <code>@tracked</code>, but we need <a href="#data-reactive-storage">cell</a> to make the cell the value of the resource (and avoid an unnecessary <code>.current</code> in uses of resources representing a single value).</li>
</ul>
<p>While <a href="https://github.com/emberjs/rfcs/blob/master/text/0669-tracked-storage-primitive.md">createStorage</a> is not currently shipped in Ember, a high-fidelity <a href="https://github.com/ember-polyfills/ember-tracked-storage-polyfill">polyfill</a> exists.</p>
<p>The current implementation of the reactivity system in Ember has a notion of description that can be used in debugging. This is a good idea, and we should align it with the design of <a href="#data-composite">composite</a> reactive objects.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="proposals.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="match.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="proposals.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="match.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
